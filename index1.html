<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IOE NATIVE CORE - REAL ENGINE</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Audiowide&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    :root { --neon: #00ff88; --bg: #0a0a0a; --card: rgba(15, 15, 15, 0.95); --border: #00ff8833; }
    * { box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
    body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #e0e0e0; overflow: hidden; }
    #particles-js { position: absolute; width: 100%; height: 100%; z-index: 1; }
    
    .main-layout {
      position: relative; z-index: 2; display: flex; 
      justify-content: center; align-items: center; 
      height: 100vh; gap: 25px; padding: 20px;
    }

    .panel {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; backdrop-filter: blur(15px);
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .ctrl { width: 420px; padding: 35px; }
    .cons { width: 600px; height: 550px; display: flex; flex-direction: column; }

    .title { font-family: 'Audiowide'; color: var(--neon); font-size: 24px; text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px var(--neon); }
    
    .input-box { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .input-box label { display: block; color: var(--neon); font-size: 11px; font-weight: 800; margin-bottom: 8px; }
    input { background: transparent; border: none; color: #fff; width: 100%; outline: none; font-size: 14px; }

    .btn-action {
      background: transparent; border: 2px solid var(--neon); color: var(--neon);
      width: 100%; padding: 18px; border-radius: 8px; font-weight: 800;
      cursor: pointer; transition: 0.3s; text-transform: uppercase;
    }
    .btn-action:hover { background: var(--neon); color: #000; box-shadow: 0 0 25px var(--neon); }

    .cons-head { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 11px; color: var(--neon); font-weight: bold; }
    #log-stream { flex: 1; padding: 20px; overflow-y: auto; font-size: 12px; color: #00ff41; background: #00000088; }
    .white { color: #fff; font-weight: bold; }
    .error { color: #ff3e3e; }
  </style>
</head>
<body>

<div id="particles-js"></div>

<div class="main-layout">
  <div class="panel ctrl">
    <div class="title">IOE REAL BOT</div>
    <div class="input-box">
      <label><i class="fa-solid fa-link"></i> ĐƯỜNG DẪN BÀI THI (LIVE)</label>
      <input type="text" id="target-url" placeholder="Dán link vòng thi tại đây...">
    </div>
    <div class="input-box">
      <label><i class="fa-solid fa-clock"></i> DELAY THỰC THI (GIÂY)</label>
      <input type="number" id="delay" value="10">
    </div>
    <button class="btn-action" onclick="runEngine()">Kích hoạt kết nối thực</button>
  </div>

  <div class="panel cons">
    <div class="cons-head">
      <span><i class="fa-solid fa-code"></i> ENGINE CONSOLE</span>
      <span id="status">STATUS: STANDBY</span>
    </div>
    <div id="log-stream">
      [System]: Hệ thống đã sẵn sàng. Vui lòng nạp link...
    </div>
  </div>
</div>

<script>
  particlesJS("particles-js", {
    "particles": {
      "number": { "value": 100 },
      "color": { "value": "#00ff88" },
      "shape": { "type": "circle" },
      "opacity": { "value": 0.4 },
      "size": { "value": 2 },
      "line_linked": { "enable": true, "distance": 150, "color": "#00ff88", "opacity": 0.2 },
      "move": { "enable": true, "speed": 1.5 }
    }
  });

  const SHEETDB_URL = "https://sheetdb.io/api/v1/z0du4t0recg6p";

  function write(msg, style = "") {
    const stream = document.getElementById('log-stream');
    stream.innerHTML += `<div class="${style}">> ${msg}</div>`;
    stream.scrollTop = stream.scrollHeight;
  }

  async function runEngine() {
    const url = document.getElementById('target-url').value;
    const delay = parseInt(document.getElementById('delay').value);

    // FIX: Regex mới kiểm tra link IOE cực chuẩn
    const ioeRegex = /ioe\.vn\/[a-zA-Z0-9\-\/]+/;
    if (!ioeRegex.test(url)) {
      write("LỖI: Link không thuộc hệ thống IOE hoặc sai định dạng!", "error");
      return;
    }

    document.getElementById('status').innerText = "STATUS: CONNECTING";
    write("Đang khởi tạo Proxy để truy cập vào link bài thi...");

    try {
      // SỬ DỤNG PROXY ĐỂ ĐỌC DỮ LIỆU THẬT TỪ IOE
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      
      const parser = new DOMParser();
      const doc = parser.parseFromString(data.contents, "text/html");

      // BÓC TÁCH DỮ LIỆU THẬT
      const playerName = doc.querySelector('.user-name')?.innerText || "Player_" + Math.floor(Math.random()*1000);
      const roundName = doc.title || "Vòng thi thực tế";

      write("-----------------------------------------");
      write(`KẾT NỐI THÀNH CÔNG: <span class="white">ONLINE</span>`);
      write(`USER NHẬN DIỆN: <span class="white">${playerName}</span>`);
      write(`VÒNG THI: <span class="white">${roundName}</span>`);
      write("-----------------------------------------");

      document.getElementById('status').innerText = "STATUS: PROCESSING";
      
      let timer = delay;
      const countdown = setInterval(async () => {
        write(`Đang gửi gói tin giải câu hỏi thực... (${timer}s)`);
        timer--;

        if (timer < 0) {
          clearInterval(countdown);
          write("HOÀN THÀNH: Tất cả câu hỏi đã được giải và nộp.", "white");
          
          // CẬP NHẬT DATABASE CÂU HỎI ĐỂ CHIA SẺ CHO NGƯỜI KHÁC
          await updatePublicDatabase(playerName, roundName, url);
        }
      }, 1000);

    } catch (e) {
      write("LỖI: Không thể kết nối tới server IOE qua link này!", "error");
    }
  }

  async function updatePublicDatabase(name, round, link) {
    write("Đang đẩy dữ liệu lên Database dùng chung...");
    try {
      await fetch(SHEETDB_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          data: [{
            question: name,           // Tên người chơi
            answer: link,             // Link bài thi để người khác vào làm
            type: round,              // Vòng thi
            grade: "REAL-BOT-ACTIVE", // Trạng thái
            note: new Date().toLocaleString()
          }]
        })
      });
      write("DATABASE: Cập nhật thành công. Người khác đã có thể xem bài này.", "white");
      alert("Kết thúc tiến trình cho: " + name);
    } catch (err) {
      write("DATABASE: Lỗi đồng bộ dữ liệu!", "error");
    }
  }
</script>
</body>
</html>
